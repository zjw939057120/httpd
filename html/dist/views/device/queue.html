<title></title>

<div class="layui-card layadmin-header">
  <div class="layui-breadcrumb" lay-filter="breadcrumb">
    <a lay-href="">主页</a>
    <a><cite>队列管理</cite></a>
  </div>
</div>

<div class="layui-fluid">
  <div class="layui-row layui-col-space15">

    <div class="layui-form layui-card-header layuiadmin-card-header-auto" lay-filter="layadmin-userfront-formlist">
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">队列列表</label>
          <div class="layui-input-block">
            <select name="queue_list" id="queue_list" lay-filter="queue_list">
              <option value="">未选择</option>
              <!-- 这里的选项会通过 AJAX 动态填充 -->
            </select>
          </div>
        </div>

        <div class="layui-inline">
          <div class="layui-input-block" style="margin-left:30px;">
            <button class="layui-btn layui-btn-danger" id="remove_queue">刪除</button>
            <button class="layui-btn layui-btn-normal" id="insert_queue">新增</button>
            <button class="layui-btn layui-btn-primary" id="copy_queue">复制</button>
          </div>
        </div>

      </div>
    </div>

    <div class="layui-col-md12">
      <div class="layui-card">

        <table class="layui-hide" id="test-table-toolbar" lay-filter="test-table-toolbar"></table>

        <script type="text/html" id="test-table-toolbar-toolbarDemo">
            <div class="layui-btn-container">
              <button class="layui-btn layui-btn-sm" lay-event="getCheckData">获取选中行数据</button>
              <button class="layui-btn layui-btn-sm" lay-event="getCheckLength">获取选中数目</button>
              <button class="layui-btn layui-btn-sm" lay-event="isAll">验证是否全选</button>
            </div>
          </script>

        <script type="text/html" id="test-table-toolbar-barDemo">
            <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
          </script>

      </div>
    </div>

  </div>
</div>

<script>
  layui.use(['admin', 'form', 'table'], function () {
    var $ = layui.$
      , admin = layui.admin
      , view = layui.view
      , element = layui.element
      , form = layui.form
      , table = layui.table;

    var queue_list = {};
    var current_queue_item = {}; // 当前选中的队列项

    initQueueList(); // 初始化时渲染队列列表
    function initQueueList() {
      // [队列列表]动态填充数据后需要重新渲染 select
      $.ajax({
        url: '/api/queue_list/get_all', // 替换为你的 JSON 接口地址
        method: 'GET',
        success: function (res) {
          queue_list = res.data; // 将数据存储到全局变量中
          if (queue_list == null) {
            layer.msg('没有队列数据', { icon: 5 });
            return;
          }
          // 假设返回的数据格式为：[{ "id": "1", "name": "队列1" }, { "id": "2", "name": "队列2" }]
          // 填充队列列表下拉框
          var queue_list_options = '';
          queue_list.forEach(function (item, index) {
            queue_list_options += '<option value="' + index + '">' + item.queue_name + '</option>';
          });
          $('#queue_list').html(queue_list_options); // 填充到 select 中

          form.render('select'); // 重新渲染表单

          var index = $('#queue_list').val();
          renderQueueItem(index); // 初始化时渲染第一个队列项
        },
        error: function () {
          console.error('请求失败');
        }
      });
    };

    // 监听[队列列表]改变事件
    form.on('select(queue_list)', function (data) {
      if (!data.value) return; // 防止未选择时触发
      renderQueueItem(data.value)
    });

    function renderQueueItem(index) {
      current_queue_item = queue_list[index]; // 获取当前选中的队列项
      console.log('当前选中的队列项:', current_queue_item); // 打印当前选中的队列项
      renderSampleList(current_queue_item.id);// 渲染样本列表
    }

    function renderSampleList(queue_id) {
      $.ajax({
        url: '/api/sample_list/get_all_by_queue/' + queue_id, // 替换为你的 JSON 接口地址
        method: 'GET',
        success: function (res) {
          if (res.code != 0) {
            layer.msg(res.msg, { icon: 5 });
            return;
          }
          var sample_list = res.data; // 获取样本列表数据
          console.log('样本列表:', sample_list); // 打印样本列表数据
        },
        error: function () {
          console.error('请求失败');
        }
      });
    }

    form.render(null, 'layadmin-userfront-formlist');

    // 监听[删除]按钮点击事件
    $('#remove_queue').on('click', function () {
      if (queue_list == null) {
        layer.msg('没有队列数据', { icon: 5 });
        return;
      }
      $.ajax({
        url: '/api/queue_list/remove/' + current_queue_item.id, // 替换为你的 JSON 接口地址
        method: 'POST',
        contentType: 'application/json',
        success: function (res) {
          if (res.code != 0) {
            layer.msg(res.msg, { icon: 5 });
            return;
          }
          initQueueList(); // 重新初始化队列列表
        },
        error: function () {
          console.error('请求失败');
        }
      });
    });

    // 监听[新增]按钮点击事件
    $('#insert_queue').on('click', function () {
      if (queue_list == null) {
        layer.msg('没有队列数据', { icon: 5 });
        return;
      }
      admin.popup({
        title: '添加队列'
        , area: ['550px', '400px']
        , id: 'LAY-popup-content-tags'
        , success: function (layero, index) {
          view(this.id).render('device/queueform').done(function () {
            form.render(null, 'layuiadmin-form-tags');

            //监听提交
            form.on('submit(layuiadmin-app-tags-submit)', function (data) {
              var field = data.field; //获取提交的字段
              console.log('提交数据:', field);

              //提交 Ajax 成功后，关闭当前弹层并重载表格
              $.ajax({
                url: '/api/queue_list/insert', // 替换为你的 JSON 接口地址
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(field), // 将数据转换为 JSON 字符串
                success: function (res) {
                  if (res.code != 0) {
                    layer.msg(res.msg, { icon: 5 });
                    return;
                  }
                  initQueueList(); // 重新初始化队列列表
                },
                error: function () {
                  console.error('请求失败');
                }
              });
              layui.table.reload('LAY-app-content-tags'); //重载表格
              layer.close(index); //执行关闭 
            });
          });
        }
      });
    });

    // 监听[复制]按钮点击事件
    $('#copy_queue').on('click', function () {
      var queue_id = current_queue_item.id;
      if (queue_list == null) {
        queue_id = -1; // 如果没有队列数据，则设置为 0
      }
      current_queue_item.queue_name = $('#queue_name').val(); // 更新队列名称
      $.ajax({
        url: '/api/queue_list/copy/' + queue_id, // 替换为你的 JSON 接口地址
        method: 'POST',
        contentType: 'application/json',
        success: function (res) {
          if (res.code != 0) {
            layer.msg(res.msg, { icon: 5 });
            return;
          }
          initQueueList(); // 重新初始化队列列表
        },
        error: function () {
          console.error('请求失败');
        }
      });
    });

    table.render({
      elem: '#test-table-toolbar'
      , url: './json/table/demo.js'
      , toolbar: '#test-table-toolbar-toolbarDemo'
      , title: '用户数据表'
      , cols: [[
        { type: 'checkbox', fixed: 'left' }
        , { field: 'id', title: 'ID', width: 80, fixed: 'left', unresize: true, sort: true }
        , { field: 'username', title: '用户名', width: 120, edit: 'text' }
        , {
          field: 'email', title: '邮箱', width: 150, edit: 'text', templet: function (res) {
            return '<em>' + res.email + '</em>'
          }
        }
        , { field: 'sex', title: '性别', width: 80, edit: 'text', sort: true }
        , { field: 'city', title: '城市', width: 100 }
        , { field: 'sign', title: '签名' }
        , { field: 'experience', title: '积分', width: 80, sort: true }
        , { field: 'ip', title: 'IP', width: 120 }
        , { field: 'logins', title: '登入次数', width: 100, sort: true }
        , { field: 'joinTime', title: '加入时间', width: 120 }
        , { fixed: 'right', title: '操作', toolbar: '#test-table-toolbar-barDemo', width: 150 }
      ]]
      , page: true
    });

    //头工具栏事件
    table.on('toolbar(test-table-toolbar)', function (obj) {
      var checkStatus = table.checkStatus(obj.config.id);
      switch (obj.event) {
        case 'getCheckData':
          var data = checkStatus.data;
          layer.alert(JSON.stringify(data));
          break;
        case 'getCheckLength':
          var data = checkStatus.data;
          layer.msg('选中了：' + data.length + ' 个');
          break;
        case 'isAll':
          layer.msg(checkStatus.isAll ? '全选' : '未全选');
          break;
      };
    });

    //监听行工具事件
    table.on('tool(test-table-toolbar)', function (obj) {
      var data = obj.data;
      if (obj.event === 'del') {
        layer.confirm('真的删除行么', function (index) {
          obj.del();
          layer.close(index);
        });
      } else if (obj.event === 'edit') {
        layer.prompt({
          formType: 2
          , value: data.email
        }, function (value, index) {
          obj.update({
            email: value
          });
          layer.close(index);
        });
      }
    });

  });
</script>